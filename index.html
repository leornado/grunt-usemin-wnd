<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <title>Grunt-usemin-wnd by leornado</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>Grunt-usemin-wnd</h1>
        <h2></h2>

        <section id="downloads">
          <a href="https://github.com/leornado/grunt-usemin-wnd/zipball/master" class="btn">Download as .zip</a>
          <a href="https://github.com/leornado/grunt-usemin-wnd/tarball/master" class="btn">Download as .tar.gz</a>
          <a href="https://github.com/leornado/grunt-usemin-wnd" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1>
<a id="grunt-usemin-wnd" class="anchor" href="#grunt-usemin-wnd" aria-hidden="true"><span class="octicon octicon-link"></span></a>grunt-usemin-wnd</h1>

<blockquote>
<p>Modified from grunt-usemin 4 personal use.</p>
</blockquote>

<p>Fix usemin. Replace revved file in same directory as first priority.</p>

<div class="highlight highlight-shell"><pre><span class="pl-k">|</span>_dir1
    <span class="pl-k">|</span>_a.css -<span class="pl-k">&gt;</span> replace with 123456.t.png
    <span class="pl-k">|</span>_t.png -<span class="pl-k">&gt;</span> 123456.t.png
<span class="pl-k">|</span>_dir2
    <span class="pl-k">|</span>_b.css -<span class="pl-k">&gt;</span> replace with abcdef.t.png
    <span class="pl-k">|</span>_t.png -<span class="pl-k">&gt;</span> abcdef.t.png</pre></div>

<p>Add 5th array element(function) to process replace result.
also see * <a href="https://www.npmjs.com/package/grunt-cmd-transport-wnd"><code>grunt-cmd-transport-wnd</code></a></p>

<div class="highlight highlight-js"><pre>...
usemin<span class="pl-k">:</span> { <span class="pl-c">// from grunt-usemin-wnd</span>
  options<span class="pl-k">:</span> {
    assetsDirs       <span class="pl-k">:</span> [
      <span class="pl-s"><span class="pl-pds">'</span>&lt;%= config.dist %&gt;/console/*<span class="pl-pds">'</span></span>,
      <span class="pl-s"><span class="pl-pds">'</span>&lt;%= config.dist %&gt;/console<span class="pl-pds">'</span></span>,
      <span class="pl-s"><span class="pl-pds">'</span>&lt;%= config.dist %&gt;<span class="pl-pds">'</span></span>
    ],
    patterns         <span class="pl-k">:</span> {
      js<span class="pl-k">:</span> [
        [
<span class="pl-sr">          <span class="pl-pds">/</span><span class="pl-c1">['"]</span>usemin:(<span class="pl-c1">[<span class="pl-k">^</span>'"]</span><span class="pl-k">*</span>)<span class="pl-c1">["']</span><span class="pl-pds">/</span>gm</span>,
          <span class="pl-s"><span class="pl-pds">'</span>Replacing seajs require parts<span class="pl-pds">'</span></span>,
          <span class="pl-k">function</span> (<span class="pl-smi">m</span>) { <span class="pl-c">// add ext '.js'</span>
            <span class="pl-k">return</span> path.extname(m) <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>.js<span class="pl-pds">'</span></span> <span class="pl-k">?</span> m <span class="pl-k">:</span> m <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>.js<span class="pl-pds">'</span></span>;
          }, ,
          <span class="pl-k">function</span> (<span class="pl-smi">m</span>) { <span class="pl-c">// cut prefix 'usemin:'</span>
            <span class="pl-k">return</span> m.<span class="pl-c1">replace</span>(<span class="pl-sr"><span class="pl-pds">/</span>usemin:<span class="pl-pds">/</span></span>, <span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>);
          }
        ]
      ]
    }
  },
  js     <span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>&lt;%= config.dist %&gt;/*/js/*.js<span class="pl-pds">'</span></span>]
}
...</pre></div>

<h1>
<a id="grunt-usemin--" class="anchor" href="#grunt-usemin--" aria-hidden="true"><span class="octicon octicon-link"></span></a>grunt-usemin <a href="https://travis-ci.org/yeoman/grunt-usemin"><img src="https://img.shields.io/travis/yeoman/grunt-usemin/master.svg?style=flat&amp;label=Linux%20build" alt="Linux Build Status"></a> <a href="https://ci.appveyor.com/project/addyosmani/grunt-usemin/branch/master"><img src="https://img.shields.io/appveyor/ci/addyosmani/grunt-usemin/master.svg?style=flat&amp;label=Windows%20build" alt="Windows Build status"></a>
</h1>

<p><a href="https://gitter.im/yeoman/grunt-usemin"><img src="https://img.shields.io/badge/GITTER-join%20chat-green.svg" alt="Gitter"></a></p>

<blockquote>
<p>Replaces references from non-optimized scripts, stylesheets and other assets to their optimized version within a set of HTML files (or any templates/views).</p>
</blockquote>

<p><strong><a href="https://github.com/yeoman/grunt-usemin/issues/313">Maintainer wanted</a></strong></p>

<h2>
<a id="notice" class="anchor" href="#notice" aria-hidden="true"><span class="octicon octicon-link"></span></a>Notice</h2>

<p><code>grunt-usemin</code> is going under some major developments to tackle the long list of issues. As they might break with <code>master</code> they are merged into <a href="https://github.com/yeoman/grunt-usemin/tree/dev">dev branch</a>.</p>

<p>Currently what has been merged:</p>

<ul>
<li>support for a <code>resolveSource</code> function option</li>
<li>warning for any missing files instead of silent errors</li>
<li>migrate from regexps to HTML parser</li>
<li>(current) support for multiple target</li>
</ul>

<h2>
<a id="getting-started" class="anchor" href="#getting-started" aria-hidden="true"><span class="octicon octicon-link"></span></a>Getting Started</h2>

<p>If you haven't used <a href="http://gruntjs.com/">grunt</a> before, be sure to check out the <a href="http://gruntjs.com/getting-started">Getting Started</a> guide, as it explains how to create a <a href="http://gruntjs.com/getting-started">gruntfile</a> as well as install and use grunt plugins. Once you're familiar with that process, install this plugin with this command:</p>

<div class="highlight highlight-shell"><pre>npm install grunt-usemin --save-dev</pre></div>

<h2>
<a id="tasks" class="anchor" href="#tasks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tasks</h2>

<p><code>usemin</code> replaces the references of scripts, stylesheets and other assets within HTML files dynamically with optimized versions of them. To do this <code>usemin</code> exports 2 built-in tasks called <code>useminPrepare</code> and <code>usemin</code> and utilizes a couple of other Grunt plugins for the optimization process. <code>usemin</code> does this by generating the subtasks for these Grunt plugins dynamically.</p>

<p>The built-in tasks of <code>usemin</code>:</p>

<ul>
<li>
<code>useminPrepare</code> prepares the configuration to transform specific blocks in the scrutinized file into a single line, targeting an optimized version of the files. This is done by generating subtasks called <code>generated</code> for each of the optimization steps handled by the Grunt plugins listed below.</li>
<li>
<code>usemin</code> replaces the blocks by the file they reference, and replaces all references to assets by their revisioned version if it is found on the disk. This target modifies the files it is working on.</li>
</ul>

<p>Grunt plugins which <code>usemin</code> can use to optimize files:</p>

<ul>
<li>
<a href="https://github.com/gruntjs/grunt-contrib-concat"><code>concat</code></a> concatenates files (usually JS or CSS).</li>
<li>
<a href="https://github.com/gruntjs/grunt-contrib-uglify"><code>uglify</code></a> minifies JS files.</li>
<li>
<a href="https://github.com/gruntjs/grunt-contrib-cssmin"><code>cssmin</code></a> minifies CSS files.</li>
<li>
<a href="https://github.com/yeoman/grunt-filerev"><code>filerev</code></a> revisions static assets through a file content hash.</li>
</ul>

<p>To install these plugins, run:</p>

<div class="highlight highlight-shell"><pre>npm install grunt-contrib-concat grunt-contrib-uglify grunt-contrib-cssmin grunt-filerev --save-dev</pre></div>

<p><strong>Important</strong>: <em>You still need to manually install and load these dependencies</em>.</p>

<p>In a typical <code>usemin</code> setup you launch <code>useminPrepare</code> first, then call every optimization step you want through their <code>generated</code> subtask and call <code>usemin</code> in the end. It could look like this:</p>

<div class="highlight highlight-js"><pre><span class="pl-c">// simple build task</span>
grunt.registerTask(<span class="pl-s"><span class="pl-pds">'</span>build<span class="pl-pds">'</span></span>, [
  <span class="pl-s"><span class="pl-pds">'</span>useminPrepare<span class="pl-pds">'</span></span>,
  <span class="pl-s"><span class="pl-pds">'</span>concat:generated<span class="pl-pds">'</span></span>,
  <span class="pl-s"><span class="pl-pds">'</span>cssmin:generated<span class="pl-pds">'</span></span>,
  <span class="pl-s"><span class="pl-pds">'</span>uglify:generated<span class="pl-pds">'</span></span>,
  <span class="pl-s"><span class="pl-pds">'</span>filerev<span class="pl-pds">'</span></span>,
  <span class="pl-s"><span class="pl-pds">'</span>usemin<span class="pl-pds">'</span></span>
]);</pre></div>

<h2>
<a id="the-useminprepare-task" class="anchor" href="#the-useminprepare-task" aria-hidden="true"><span class="octicon octicon-link"></span></a>The useminPrepare task</h2>

<p><code>useminPrepare</code> task updates the grunt configuration to apply a configured transformation flow to tagged files (i.e. blocks).
By default the transformation flow is composed of <code>concat</code> and <code>uglify</code> for JS files, but it can be configured.</p>

<h3>
<a id="blocks" class="anchor" href="#blocks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Blocks</h3>

<p>Blocks are expressed as:</p>

<div class="highlight highlight-html"><pre><span class="pl-c">&lt;!-- build:&lt;type&gt;(alternate search path) &lt;path&gt; --&gt;</span>
... HTML Markup, list of script / link tags.
<span class="pl-c">&lt;!-- endbuild --&gt;</span></pre></div>

<ul>
<li>
<strong>type</strong>: can be <code>js</code>, <code>css</code> or a custom type with a <a href="#blockreplacements">block replacement function</a> defined

<ul>
<li>If another type, the block will be ignored.  Useful for "development only" blocks that won't appear in your build</li>
</ul>
</li>
<li>
<strong>alternate search path</strong>: (optional) By default the input files are relative to the treated file. Alternate search path allows one to change that</li>
<li>
<strong>path</strong>: the file path of the optimized file, the target output</li>
</ul>

<p>An example of this in completed form can be seen below:</p>

<div class="highlight highlight-html"><pre><span class="pl-c">&lt;!-- build:js js/app.js --&gt;</span>
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>js/app.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>js/controllers/thing-controller.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>js/models/thing-model.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>js/views/thing-view.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
<span class="pl-c">&lt;!-- endbuild --&gt;</span></pre></div>

<h3>
<a id="transformation-flow" class="anchor" href="#transformation-flow" aria-hidden="true"><span class="octicon octicon-link"></span></a>Transformation flow</h3>

<p>The transformation flow is made of sequential steps: each of the steps transform the file, and useminPrepare will modify the configuration in order for the described steps to be correctly performed.</p>

<p>By default the flow is: <code>concat -&gt; uglify</code>.
Additionally to the flow, at the end, some postprocessors can be launched to further alter the configuration.</p>

<p>Let's have an example, using the default flow (we're just going to look at the steps), <code>app</code> for input dir, <code>dist</code> for output dir,  and the following block:</p>

<div class="highlight highlight-html"><pre><span class="pl-c">&lt;!-- build:js js/app.js --&gt;</span>
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>js/app.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>js/controllers/thing-controller.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>js/models/thing-model.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>js/views/thing-view.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
<span class="pl-c">&lt;!-- endbuild --&gt;</span></pre></div>

<p>The produced configuration will look like:</p>

<div class="highlight highlight-js"><pre>{
  concat<span class="pl-k">:</span> {
    generated<span class="pl-k">:</span> {
      files<span class="pl-k">:</span> [
        {
          dest<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>.tmp/concat/js/app.js<span class="pl-pds">'</span></span>,
          src<span class="pl-k">:</span> [
            <span class="pl-s"><span class="pl-pds">'</span>app/js/app.js<span class="pl-pds">'</span></span>,
            <span class="pl-s"><span class="pl-pds">'</span>app/js/controllers/thing-controller.js<span class="pl-pds">'</span></span>,
            <span class="pl-s"><span class="pl-pds">'</span>app/js/models/thing-model.js<span class="pl-pds">'</span></span>,
            <span class="pl-s"><span class="pl-pds">'</span>app/js/views/thing-view.js<span class="pl-pds">'</span></span>
          ]
        }
      ]
    }
  },
  uglify<span class="pl-k">:</span> {
    generated<span class="pl-k">:</span> {
      files<span class="pl-k">:</span> [
        {
          dest<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>dist/js/app.js<span class="pl-pds">'</span></span>,
          src<span class="pl-k">:</span> [ <span class="pl-s"><span class="pl-pds">'</span>.tmp/concat/js/app.js<span class="pl-pds">'</span></span> ]
        }
      ]
    }
  }
}</pre></div>

<h3>
<a id="directories" class="anchor" href="#directories" aria-hidden="true"><span class="octicon octicon-link"></span></a>Directories</h3>

<p>Internally, the task parses your HTML markup to find each of these blocks, and initializes the corresponding Grunt config for the concat / uglify tasks when <code>type=js</code>, the concat / cssmin tasks when <code>type=css</code>.</p>

<p>One doesn't need to specify a concat/uglify/cssmin configuration anymore.</p>

<p>It uses only one target: <code>html</code>, with a list of the concerned files. For example, in your <code>Gruntfile.js</code>:</p>

<p>By default, it will consider the directory where the looked-at file is located as the 'root' filesystem. Each relative path (for example to a javascript file) will be resolved from this path. Same goes for the absolute ones.
If you need to change the 'root' dir, use the <code>root</code> option (see below).</p>

<div class="highlight highlight-js"><pre>useminPrepare<span class="pl-k">:</span> {
  html<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>index.html<span class="pl-pds">'</span></span>
}</pre></div>

<p>Targets can also be configured using the grunt src-dest files syntax <a href="http://gruntjs.com/configuring-tasks#files">http://gruntjs.com/configuring-tasks#files</a>, e.g.</p>

<div class="highlight highlight-js"><pre>useminPrepare<span class="pl-k">:</span> {
  foo<span class="pl-k">:</span> {
    src<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>index.html<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>another.html<span class="pl-pds">'</span></span>]
  },
  bar<span class="pl-k">:</span> {
    src<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>index.html<span class="pl-pds">'</span></span>
  }
}</pre></div>

<h3>
<a id="options" class="anchor" href="#options" aria-hidden="true"><span class="octicon octicon-link"></span></a>Options</h3>

<h3>
<a id="dest" class="anchor" href="#dest" aria-hidden="true"><span class="octicon octicon-link"></span></a>dest</h3>

<p>Type: 'string'<br>
Default: <code>nil</code></p>

<p>Base directory where the transformed files should be output.</p>

<h3>
<a id="staging" class="anchor" href="#staging" aria-hidden="true"><span class="octicon octicon-link"></span></a>staging</h3>

<p>Type: 'string'<br>
Default: <code>.tmp</code></p>

<p>Base directory where the temporary files should be output (e.g. concatenated files).</p>

<h3>
<a id="root" class="anchor" href="#root" aria-hidden="true"><span class="octicon octicon-link"></span></a>root</h3>

<p>Type: 'string' or 'Array'<br>
Default: <code>nil</code></p>

<p>The root directory from which your files will be resolved.</p>

<h3>
<a id="flow" class="anchor" href="#flow" aria-hidden="true"><span class="octicon octicon-link"></span></a>flow</h3>

<p>Type: 'object'<br>
Default: <code>{ steps: { js: ['concat', 'uglify'], css: ['concat', 'cssmin'] }, post: {} }</code></p>

<p>This allow you to configure the workflow, either on a per-target basis, or for all the targets.
You can change the <code>steps</code> or the post-processors (<code>post</code>) separately.</p>

<p>For example:</p>

<ul>
<li>to change the <code>js</code> <code>steps</code> and <code>post</code> for the target <code>html</code>:</li>
</ul>

<div class="highlight highlight-js"><pre>useminPrepare<span class="pl-k">:</span> {
  html<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>index.html<span class="pl-pds">'</span></span>,
  options<span class="pl-k">:</span> {
    flow<span class="pl-k">:</span> {
      html<span class="pl-k">:</span> {
        steps<span class="pl-k">:</span> {
          js<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>uglify<span class="pl-pds">'</span></span>]
        },
        post<span class="pl-k">:</span> {}
      }
    }
  }
}</pre></div>

<ul>
<li>to change the <code>js</code> <code>steps</code> and <code>post</code> for all targets:</li>
</ul>

<div class="highlight highlight-js"><pre>useminPrepare<span class="pl-k">:</span> {
  html<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>index.html<span class="pl-pds">'</span></span>,
  options<span class="pl-k">:</span> {
    flow<span class="pl-k">:</span> {
      steps<span class="pl-k">:</span> {
        js<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>uglify<span class="pl-pds">'</span></span>]
      },
      post<span class="pl-k">:</span> {}
    }
  }
}</pre></div>

<ul>
<li>to customize the generated configuration via post-processors:</li>
</ul>

<div class="highlight highlight-js"><pre>useminPrepare<span class="pl-k">:</span> {
  html<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>index.html<span class="pl-pds">'</span></span>,
  options<span class="pl-k">:</span> {
    flow<span class="pl-k">:</span> {
      steps<span class="pl-k">:</span> {
        js<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>uglify<span class="pl-pds">'</span></span>]
      },
      post<span class="pl-k">:</span> {
        js<span class="pl-k">:</span> [{
          name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>uglify<span class="pl-pds">'</span></span>,
          <span class="pl-en">createConfig</span>: <span class="pl-k">function</span> (<span class="pl-smi">context</span>, <span class="pl-smi">block</span>) {
            <span class="pl-k">var</span> generated <span class="pl-k">=</span> context.<span class="pl-c1">options</span>.generated;
            generated.<span class="pl-c1">options</span> <span class="pl-k">=</span> {
              foo<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>bar<span class="pl-pds">'</span></span>
            };
          }
        }]
      }
    }
  }
}</pre></div>

<p>The given steps or post-processors may be specified as strings (for the default steps and post-processors), or as an object (for the user-defined ones).</p>

<h4>
<a id="user-defined-steps-and-post-processors" class="anchor" href="#user-defined-steps-and-post-processors" aria-hidden="true"><span class="octicon octicon-link"></span></a>User-defined steps and post-processors</h4>

<p>User-defined steps and post-processors must have 2 attributes:</p>

<ul>
<li>
<code>name</code>: name of the <code>Gruntfile</code> attribute that holds the corresponding config</li>
<li>
<code>createConfig</code> which is a 2 arguments function ( a <code>context</code> and the treated <code>block</code>)</li>
</ul>

<p>For an example of steps/post-processors, you can have a look at <code>concat</code> and <code>uglify</code> in the <code>lib/config</code> directory of this repository.</p>

<h5>
<a id="createconfig" class="anchor" href="#createconfig" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>createConfig</code>
</h5>

<p>The <code>createConfig</code> function is responsible for creating (or updating) the configuration associated to the current step/post-processor.
It takes 2 arguments ( a <code>context</code> and the treated <code>block</code>), and returns a configuration object.</p>

<h6>
<a id="context" class="anchor" href="#context" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>context</code>
</h6>

<p>The <code>context</code> object represent the current context the step/post-processor is running in. As the step/post-processor is a step of a flow, it must be listed in the input files and directory it must write a configuration for, potentially the already existing configuration. It must also indicate to the other steps/post-processor which files it will output in which directory. All this information is held by the <code>context</code> object.
Attributes:</p>

<ul>
<li>
<code>inDir</code>: the directory where the <code>input</code> file for the step/post-processors will be</li>
<li>
<code>inFiles</code>: the list of input file to take care of</li>
<li>
<code>outDir</code>: where the files created by the step/post-processors will be</li>
<li>
<code>outFiles</code>: the files that are going to be created</li>
<li>
<code>last</code>: whether or not we're the last step of the flow</li>
<li>
<code>options</code>: options of the <code>Gruntfile.js</code> for this step (e.g. if the step is named <code>foo</code>, holds configuration of the <code>Gruntfile.js</code> associated to the attribute <code>foo</code>)</li>
</ul>

<h6>
<a id="block" class="anchor" href="#block" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>block</code>
</h6>

<p>The actual looked-at block, parsed an put in a structure.</p>

<p>Example:
The following block</p>

<div class="highlight highlight-html"><pre><span class="pl-c">&lt;!-- build:js scripts/site.js --&gt;</span>',
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>foo.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;',
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>bar.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;',
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>baz.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;',
<span class="pl-c">&lt;!-- endbuild --&gt;</span>'</pre></div>

<p>is parsed as, and given to <code>createConfig</code> as:</p>

<div class="highlight highlight-js"><pre><span class="pl-k">var</span> block <span class="pl-k">=</span> {
  type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>js<span class="pl-pds">'</span></span>,
  dest<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>scripts/site.js<span class="pl-pds">'</span></span>,
  src<span class="pl-k">:</span> [
    <span class="pl-s"><span class="pl-pds">'</span>foo.js<span class="pl-pds">'</span></span>,
    <span class="pl-s"><span class="pl-pds">'</span>bar.js<span class="pl-pds">'</span></span>,
    <span class="pl-s"><span class="pl-pds">'</span>baz.js<span class="pl-pds">'</span></span>
  ],
  raw<span class="pl-k">:</span> [
    <span class="pl-s"><span class="pl-pds">'</span>    &lt;!-- build:js scripts/site.js --&gt;<span class="pl-pds">'</span></span>,
    <span class="pl-s"><span class="pl-pds">'</span>    &lt;script src="foo.js"&gt;&lt;/script&gt;<span class="pl-pds">'</span></span>,
    <span class="pl-s"><span class="pl-pds">'</span>    &lt;script src="bar.js"&gt;&lt;/script&gt;<span class="pl-pds">'</span></span>,
    <span class="pl-s"><span class="pl-pds">'</span>    &lt;script src="baz.js"&gt;&lt;/script&gt;<span class="pl-pds">'</span></span>,
    <span class="pl-s"><span class="pl-pds">'</span>    &lt;!-- endbuild --&gt;<span class="pl-pds">'</span></span>
  ]
};</pre></div>

<h2>
<a id="the-usemin-task" class="anchor" href="#the-usemin-task" aria-hidden="true"><span class="octicon octicon-link"></span></a>The usemin task</h2>

<p>The <code>usemin</code> task has 2 actions:</p>

<ul>
<li>First it replaces all the blocks with a single "summary" line, pointing to a file creating by the transformation flow.</li>
<li>Then it looks for references to assets (i.e. images, scripts, ...), and tries to replace them with their revved version if it can find one on disk</li>
</ul>

<h3>
<a id="finding-assets" class="anchor" href="#finding-assets" aria-hidden="true"><span class="octicon octicon-link"></span></a>Finding assets</h3>

<p>By default <code>usemin</code> will look for a map object created by <a href="https://github.com/yeoman/grunt-filerev">grunt-filerev</a>, located in <code>grunt.filerev.summary</code>. If it does not find it it will revert to disk lookup which is longer.</p>

<p>Note that by using the <code>options.revmap</code> (see below), you can furnish a map object.</p>

<h3>
<a id="on-directories" class="anchor" href="#on-directories" aria-hidden="true"><span class="octicon octicon-link"></span></a>On directories</h3>

<p>When <code>usemin</code> tries to replace referenced assets with their revved version it has to look at a collection of directories (asset search paths): for each of the directories of this collection it will look at the below tree, and try to find the revved version.
This asset search directories collection is by default set to the location of the file that is scrutinized but can be modified (see Options below).</p>

<h4>
<a id="example-1-file-disthtmlindexhtml-has-the-following-content" class="anchor" href="#example-1-file-disthtmlindexhtml-has-the-following-content" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example 1: file <code>dist/html/index.html</code> has the following content:</h4>

<div class="highlight highlight-html"><pre>&lt;<span class="pl-ent">link</span> <span class="pl-e">rel</span>=<span class="pl-s"><span class="pl-pds">"</span>stylesheet<span class="pl-pds">"</span></span> <span class="pl-e">href</span>=<span class="pl-s"><span class="pl-pds">"</span>styles/main.css<span class="pl-pds">"</span></span>&gt;
&lt;<span class="pl-ent">img</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>../images/test.png<span class="pl-pds">"</span></span>&gt;</pre></div>

<p>By default <code>usemin</code> will look under <code>dist/html</code> for revved versions of:</p>

<ul>
<li>
<code>styles/main.css</code>: a revved version of <code>main.css</code> will be looked at under the <code>dist/html/styles</code> directory. For example a file <code>dist/html/styles/main.1234.css</code> will match (although <code>dist/html/main.1234.css</code> won't: the path of the referenced file is important)</li>
<li>
<code>../images/test.png</code>: it basically means that a revved version of <code>test.png</code> will be looked for under the <code>dist/images</code> directory</li>
</ul>

<h4>
<a id="example-2-file-disthtmlindexhtml-has-the-following-content" class="anchor" href="#example-2-file-disthtmlindexhtml-has-the-following-content" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example 2: file <code>dist/html/index.html</code> has the following content:</h4>

<div class="highlight highlight-html"><pre>&lt;<span class="pl-ent">link</span> <span class="pl-e">rel</span>=<span class="pl-s"><span class="pl-pds">"</span>stylesheet<span class="pl-pds">"</span></span> <span class="pl-e">href</span>=<span class="pl-s"><span class="pl-pds">"</span>/styles/main.css<span class="pl-pds">"</span></span>&gt;
&lt;<span class="pl-ent">img</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>/images/test.png<span class="pl-pds">"</span></span>&gt;</pre></div>

<p>By default <code>usemin</code> will look under <code>dist/html</code> for revved versions of <code>styles/main.css</code> and <code>images/test.png</code>. Now let's suppose our assets are scattered in <code>dist/assets</code>. By changing the asset search path list to <code>['dist/assets']</code>, the revved versions of the files will be searched for under <code>dist/assets</code> (and thus, for example, <code>dist/assets/images/test.875487.png</code> and <code>dist/assets/styles/main.98090.css</code>) will be found.</p>

<h3>
<a id="options-1" class="anchor" href="#options-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Options</h3>

<h4>
<a id="assetsdirs" class="anchor" href="#assetsdirs" aria-hidden="true"><span class="octicon octicon-link"></span></a>assetsDirs</h4>

<p>Type: 'Array'<br>
Default: Single item array set to the value of the directory where the currently looked at file is.</p>

<p>List of directories where we should start to look for <em>revved version</em> of the assets referenced in the currently looked at file.</p>

<p>Example:</p>

<div class="highlight highlight-js"><pre>usemin<span class="pl-k">:</span> {
  html<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>build/index.html<span class="pl-pds">'</span></span>,
  options<span class="pl-k">:</span> {
    assetsDirs<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>foo/bar<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>bar<span class="pl-pds">'</span></span>]
  }
}</pre></div>

<p>Suppose in <code>index.html</code> you have a reference to <code>/images/foo.png</code>, <code>usemin</code> will search for the revved version of <code>/images/foo.png</code>, say <code>/images/foo.12345678.png</code> in any directories in <code>assetsDirs</code> options.</p>

<p>In others words, given the configuration above, <code>usemin</code> will search for the existence of one of these files:</p>

<ul>
<li>foo/bar/images/foo.12345678.png</li>
<li>bar/images/foo.12345678.png</li>
</ul>

<h4>
<a id="patterns" class="anchor" href="#patterns" aria-hidden="true"><span class="octicon octicon-link"></span></a>patterns</h4>

<p>Type: 'Object'<br>
Default: Empty</p>

<p>Allows for user defined pattern to replace reference to files. For example, let's suppose that you want to replace
all references to <code>'image.png'</code> in your Javascript files by the revved version of <code>image.png</code> found below the directory <code>images</code>.
By specifying something along the lines of:</p>

<div class="highlight highlight-js"><pre>usemin<span class="pl-k">:</span> {
  js<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>*.js<span class="pl-pds">'</span></span>,
  options<span class="pl-k">:</span> {
    assetsDirs<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>images<span class="pl-pds">'</span></span>,
    patterns<span class="pl-k">:</span> {
      js<span class="pl-k">:</span> [
        [<span class="pl-sr"><span class="pl-pds">/</span>(image<span class="pl-cce">\.</span>png)<span class="pl-pds">/</span></span>, <span class="pl-s"><span class="pl-pds">'</span>Replacing reference to image.png<span class="pl-pds">'</span></span>]
      ]
    }
  }
}</pre></div>

<p>So in short:</p>

<ul>
<li>key in pattern should match the target (e.g <code>js</code> key for the target <code>js</code>)</li>
<li>Each pattern is an array of arrays. These arrays are composed of 4 items (last 2 are optional):

<ul>
<li>First one if the regexp to use. The first group is the one that is supposed to represent the file
reference to replace</li>
<li>Second one is a logging string</li>
<li>A function which behaves like a filter-in. Receives the matched group and must return the file
path of the asset. Great functionality when you have a compiled file by a template engine.</li>
<li>A function which behaves like a filter-out. It receives the revved path of the asset and must
return it as an url from it will be reached from web server.</li>
</ul>
</li>
</ul>

<h4>
<a id="blockreplacements" class="anchor" href="#blockreplacements" aria-hidden="true"><span class="octicon octicon-link"></span></a>blockReplacements</h4>

<p>Type: 'Object'<br>
Default: <code>{ css: function (block) { ... }, js: function (block) { ... } }</code></p>

<p>This lets you define how blocks get their content replaced. Useful to have block types other that <code>css</code> and <code>js</code>.</p>

<ul>
<li>Object key matches a block type</li>
<li>Value is the replacement function for that block type.

<ul>
<li>The replacement function gets called with a single argument: a <a href="#block">block</a> object.</li>
<li>Must return a <code>String</code>, the "summary" line that will replace the block content.</li>
</ul>
</li>
</ul>

<p>For example, to create a <code>less</code> block you could define its replacement function like this:</p>

<div class="highlight highlight-js"><pre>usemin<span class="pl-k">:</span> {
  html<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>index.html<span class="pl-pds">'</span></span>,
  options<span class="pl-k">:</span> {
    blockReplacements<span class="pl-k">:</span> {
      <span class="pl-en">less</span>: <span class="pl-k">function</span> (<span class="pl-smi">block</span>) {
          <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;link rel="stylesheet" href="<span class="pl-pds">'</span></span> <span class="pl-k">+</span> block.dest <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>"&gt;<span class="pl-pds">'</span></span>;
      }
    }
  }
}</pre></div>

<h4>
<a id="revmap" class="anchor" href="#revmap" aria-hidden="true"><span class="octicon octicon-link"></span></a>revmap</h4>

<p>Type: 'String'<br>
Default: Empty</p>

<p>Indicate the location of a map file, as produced by <code>grunt-filerev</code> for example. This map file is a simple JSON file, holding an object
which attributes are the original file and associated value is the transformed file. For example:</p>

<div class="highlight highlight-js"><pre>{
  <span class="pl-s"><span class="pl-pds">"</span>foo.png<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>foo.1234.png<span class="pl-pds">"</span></span>
}</pre></div>

<p>This map will be used instead of looking for file on the disk.</p>

<h2>
<a id="on-directories-1" class="anchor" href="#on-directories-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>On directories</h2>

<p>The main difference to be kept in mind, regarding directories and tasks, is that for <code>useminPrepare</code>, the directories needs to indicate the input,
transient and output path needed to output the right configuration for the processors pipeline,
whereas in the case of <code>usemin</code> it only reflects the output paths, as all the needed assets should have
been output to the destination dir (either transformed or just copied)</p>

<h3>
<a id="useminprepare" class="anchor" href="#useminprepare" aria-hidden="true"><span class="octicon octicon-link"></span></a>useminPrepare</h3>

<p><code>useminPrepare</code> is trying to prepare the right configuration for the pipeline of actions that are going to be
applied on the blocks (for example concatenation and uglify-cation). As such it needs to have the input
directory, temporary directories (staging) and destination directory.
The files referenced in the block are either absolute or relative (<code>/images/foo.png</code> or <code>../../images/foo.png</code>).
Absolute files references are looked in a given set of search path (input), which by default is set
to the directory where the html/css file examined is located (can be overridden per block, or more
generally through <code>root</code> option).
Relative files references are also looked at from location of the examined file, unless stated otherwise.</p>

<h3>
<a id="usemin" class="anchor" href="#usemin" aria-hidden="true"><span class="octicon octicon-link"></span></a>usemin</h3>

<p><code>usemin</code> target replaces references to images, scripts, css, ... in the furnished files (html, css, ...).
These references may be either absolute (i.e. <code>/images/foo.png</code>) or relative (i.e. <code>image/foo.png</code>
or <code>../images/foo.png</code>).
When the reference is absolute a set of asset search paths should be looked at under the
destination directory (for example, using the previous example, and <code>searchpath</code>
equal to <code>['assets']</code>, <code>usemin</code> would try to find either a revved version of the image
of the image below the <code>assets</code> directory: for example <code>dest/assets/images/foo.1223443.png</code>).
When the reference is relative, by default the referenced item is looked in the path
relative <em>to the current file location</em> in the destination directory (e.g. with the
preceding example, if the file is <code>build/bar/index.html</code>, then transformed <code>index.html</code>
will be in <code>dist/bar</code>, and <code>usemin</code> will look for <code>dist/bar/../images/foo.32323.png</code>).</p>

<h2>
<a id="use-cases" class="anchor" href="#use-cases" aria-hidden="true"><span class="octicon octicon-link"></span></a>Use cases</h2>

<h3>
<a id="simple-one" class="anchor" href="#simple-one" aria-hidden="true"><span class="octicon octicon-link"></span></a>Simple one</h3>

<pre><code>|
+- app
|   +- index.html
|   +- assets
|       +- js
|          +- foo.js
|          +- bar.js
+- dist

</code></pre>

<p>We want to optimize <code>foo.js</code> and <code>bar.js</code> into <code>optimized.js</code>, referenced using relative path. <code>index.html</code> should contain the following block:</p>

<div class="highlight highlight-html"><pre><span class="pl-c">&lt;!-- build:js assets/js/optimized.js --&gt;</span>
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>assets/js/foo.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>assets/js/bar.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
<span class="pl-c">&lt;!-- endbuild --&gt;</span></pre></div>

<p>We want our files to be generated in the <code>dist</code> directory.</p>

<p>By using the following <code>useminPrepare</code> config:</p>

<div class="highlight highlight-js"><pre>{
  useminPrepare<span class="pl-k">:</span> {
    html<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>app/index.html<span class="pl-pds">'</span></span>,
    options<span class="pl-k">:</span> {
      dest<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>dist<span class="pl-pds">'</span></span>
    }
  }
}</pre></div>

<p>This will, on the fly, generate the following configuration:</p>

<div class="highlight highlight-js"><pre>{
  concat<span class="pl-k">:</span>
  {
    <span class="pl-s"><span class="pl-pds">'</span>.tmp/concat/assets/js/optimized.js<span class="pl-pds">'</span></span><span class="pl-k">:</span> [
      <span class="pl-s"><span class="pl-pds">'</span>app/assets/js/foo.js<span class="pl-pds">'</span></span>,
      <span class="pl-s"><span class="pl-pds">'</span>app/assets/js/bar.js<span class="pl-pds">'</span></span>
    ]
  },

  uglify<span class="pl-k">:</span>
  {
    <span class="pl-s"><span class="pl-pds">'</span>dist/assets/js/optimized.js<span class="pl-pds">'</span></span><span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>.tmp/concat/assets/js/optimized.js<span class="pl-pds">'</span></span>]
  }
}</pre></div>

<h3>
<a id="html-file-and-asset-files-in-sibling-directories" class="anchor" href="#html-file-and-asset-files-in-sibling-directories" aria-hidden="true"><span class="octicon octicon-link"></span></a>HTML file and asset files in sibling directories</h3>

<pre><code>app
|
+- html
|   +- index.html
+- assets
|   +- js
|      +- foo.js
|      +- bar.js
+- dist

</code></pre>

<p>We want to optimize <code>foo.js</code> and <code>bar.js</code> into <code>optimized.js</code>, referenced using absolute path. <code>index.html</code> should contain the following block:</p>

<div class="highlight highlight-html"><pre><span class="pl-c">&lt;!-- build:js /assets/js/optimized.js --&gt;</span>
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>/assets/js/foo.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
&lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>/assets/js/bar.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;
<span class="pl-c">&lt;!-- endbuild --&gt;</span></pre></div>

<p>We want our files to be generated in the <code>dist</code> directory.</p>

<p>By using the following <code>useminPrepare</code> config:</p>

<div class="highlight highlight-js"><pre>{
  useminPrepare<span class="pl-k">:</span> {
    html<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>html/index.html<span class="pl-pds">'</span></span>,
    options<span class="pl-k">:</span> {
      root<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>app<span class="pl-pds">'</span></span>,
      dest<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>dist<span class="pl-pds">'</span></span>
    }
  }
}</pre></div>

<p>This will, on the fly, generate the following configuration:</p>

<div class="highlight highlight-js"><pre>{
  concat<span class="pl-k">:</span>
  {
    <span class="pl-s"><span class="pl-pds">'</span>.tmp/concat/assets/js/optimized.js<span class="pl-pds">'</span></span><span class="pl-k">:</span> [
      <span class="pl-s"><span class="pl-pds">'</span>app/assets/js/foo.js<span class="pl-pds">'</span></span>,
      <span class="pl-s"><span class="pl-pds">'</span>app/assets/js/bar.js<span class="pl-pds">'</span></span>
    ]
  },

  uglify<span class="pl-k">:</span>
  {
    <span class="pl-s"><span class="pl-pds">'</span>dist/assets/js/optimized.js<span class="pl-pds">'</span></span><span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>.tmp/concat/assets/js/optimized.js<span class="pl-pds">'</span></span>]
  }
}</pre></div>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p><a href="http://opensource.org/licenses/bsd-license.php">BSD license</a> and copyright Google</p>
      </section>
    </div>

    
  </body>
</html>